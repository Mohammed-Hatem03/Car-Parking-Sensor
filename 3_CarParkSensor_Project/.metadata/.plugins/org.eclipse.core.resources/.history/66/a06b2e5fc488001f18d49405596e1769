#include "ultrasonic.h"
#include "icu.h"
#include "gpio.h"
#include <avr/io.h>

static uint16 g_timeHigh = 0;

void Ultrasonic_init(void){
	ICU_ConfigType ICU_Configurations = {F_CPU_8,RAISING};
	ICU_init(&ICU_Configurations);
	ICU_setCallBack(Ultrasonic_edgeProcessing);
	GPIO_setupPinDirection(ULTRASONIC_PORT_ID,ULTRASONIC_ECHO_PIN_ID,PIN_INPUT);
	GPIO_setupPinDirection(ULTRASONIC_PORT_ID,ULTRASONIC_TRIGGER_PIN_ID,PIN_OUTPUT);
}
void Ultrasonic_trigger(void){
	GPIO_writePin(ULTRASONIC_PORT_ID,ULTRASONIC_TRIGGER_PIN_ID,LOGIC_HIGH);
}
uint16 Ultrasonic_readDistance(void){
	uint8 distance ;
	Ultrasonic_trigger();
	g_timeHigh = ICU_getInputCaptureValue();
	distance = (float)(g_timeHigh/117.6);

	return distance;
}
void Ultrasonic_edgeProcessing(void){
	static uint8 edge_counts = 0;
	if(edge_counts == 0)
	{
		TCNT1 = 0;
		ICU_setEdgeDetectionType(FALLING);
		edge_counts++;
	}
	else if(edge_counts == 1)
	{
		ICU_setEdgeDetectionType(RAISING);
		edge_counts = 0;
	}
}
